function handleQueryResponse(response) {
  if (response.isError()) {
    document.getElementById('kalendarz').innerHTML = 'Błąd w pobieraniu danych: ' + response.getMessage();
    return;
  }

  const data = response.getDataTable();
  const rows = data.getNumberOfRows();
  allRezerwacje = [];

  for (let i = 0; i < rows; i++) {
    const dataOd = new Date(data.getValue(i, 0));
    const dataDo = new Date(data.getValue(i, 1));
    const domek = data.getValue(i, 2);
    const imieNazwisko = data.getValue(i, 3);
    const inicjaly = imieNazwisko ? imieNazwisko.substring(0, 3).toUpperCase() : '';

    // W tym obiekcie zapiszemy dni rezerwacji dla tego wiersza, żeby potem sprawdzić start i end na tym samym dniu
    const dniRezerwacji = [];

    for (let d = new Date(dataOd); d <= dataDo; d.setDate(d.getDate() + 1)) {
      dniRezerwacji.push(new Date(d));
    }

    dniRezerwacji.forEach((dzien, idx) => {
      const dzienStr = formatDate(dzien);
      let typ = 'pełny';

      if (formatDate(dataOd) === formatDate(dataDo)) {
        // Start i koniec tego samego dnia - dzień zmiany osoby
        typ = 'both';
      } else if (idx === 0) {
        typ = 'start';
      } else if (idx === dniRezerwacji.length - 1) {
        typ = 'end';
      }

      allRezerwacje.push({
        domek,
        dzien: dzienStr,
        inicjaly,
        typ
      });
    });
  }

  // Teraz łączymy wpisy, jeśli start i end są tego samego dnia i tego samego domku,
  // żeby wyświetlić oba inicjały i napisy oddzielnie

  // Grupujemy po domek + dzień
  const rezerwacjeMap = new Map();

  allRezerwacje.forEach(r => {
    const key = r.domek + '|' + r.dzien;
    if (!rezerwacjeMap.has(key)) {
      rezerwacjeMap.set(key, []);
    }
    rezerwacjeMap.get(key).push(r);
  });

  // Teraz tworzymy nową listę allRezerwacje z uwzględnieniem dni zmiany
  allRezerwacje = [];

  for (const [key, entries] of rezerwacjeMap.entries()) {
    const domek = entries[0].domek;
    const dzien = entries[0].dzien;

    const hasStart = entries.some(e => e.typ === 'start');
    const hasEnd = entries.some(e => e.typ === 'end');
    const inicjalyStart = entries.find(e => e.typ === 'start')?.inicjaly || '';
    const inicjalyEnd = entries.find(e => e.typ === 'end')?.inicjaly || '';

    if (hasStart && hasEnd) {
      // Dzień zmiany osoby - oba inicjały w jednej komórce
      allRezerwacje.push({
        domek,
        dzien,
        inicjaly: inicjalyStart + ' ' + inicjalyEnd,
        typ: 'both'
      });
    } else if (hasStart) {
      allRezerwacje.push({
        domek,
        dzien,
        inicjaly: inicjalyStart,
        typ: 'start'
      });
    } else if (hasEnd) {
      allRezerwacje.push({
        domek,
        dzien,
        inicjaly: inicjalyEnd,
        typ: 'end'
      });
    } else {
      // Pełne dni (środkowe)
      const full = entries.find(e => e.typ === 'pełny');
      if (full) {
        allRezerwacje.push({
          domek,
          dzien,
          inicjaly: full.inicjaly,
          typ: 'pełny'
        });
      }
    }
  }

  // Ustawiamy miesiąc i rok na dziś
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();

  renderCalendar(currentYear, currentMonth);
  setupNavigation();
}

function renderCalendar(year, month) {
  const kalendarzDiv = document.getElementById('kalendarz');
  document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

  const filteredRezerwacje = allRezerwacje.filter(r => {
    const date = new Date(r.dzien);
    return date.getFullYear() === year && date.getMonth() === month;
  });

  const datySet = new Set();
  const domkiSet = new Set();

  filteredRezerwacje.forEach(r => {
    datySet.add(r.dzien);
    domkiSet.add(r.domek);
  });

  if (datySet.size === 0) {
    kalendarzDiv.innerHTML = "<p style='text-align:center;'>Brak rezerwacji w tym miesiącu.</p>";
    return;
  }

  const daty = Array.from(datySet).sort();
  const domki = Array.from(domkiSet).sort();

  let html = '<table><thead><tr><th>Domek</th>';
  daty.forEach(d => {
    const day = d.split('-')[2];
    html += `<th>${day}</th>`;
  });
  html += '</tr></thead><tbody>';

  domki.forEach(domek => {
    html += `<tr><td>${domek}</td>`;
    daty.forEach(dzien => {
      const wpis = filteredRezerwacje.find(r => r.domek === domek && r.dzien === dzien);
      if (wpis) {
        let klasa = 'occupied';
        if (wpis.typ === 'start') klasa = 'partial-start';
        else if (wpis.typ === 'end') klasa = 'partial-end';
        else if (wpis.typ === 'both') klasa = 'partial-both';

        // Tekst z napisem "Zajęte" i inicjałami w dwóch akapitach
        html += `<td class="${klasa}"><p>Zajęte</p><p>${wpis.inicjaly}</p></td>`;
      } else {
        html += `<td></td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  kalendarzDiv.innerHTML = html;
}
