<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dynamiczny kalendarz rezerwacji</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 1em auto; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; text-align: center; padding: 0.5em; }
  th { background: #f0f0f0; }
  .today { background: #d0f0d0; }
  .busy { background: #f08080; color: white; font-weight: bold; cursor: default; }
  .nav-btn { cursor: pointer; font-weight: bold; padding: 0.2em 0.5em; user-select: none; }
  .nav-btn:hover { background: #ddd; }
  caption { margin-bottom: 0.5em; font-weight: bold; font-size: 1.2em; }
</style>
</head>
<body>
<h1>Kalendarz rezerwacji</h1>
<div style="text-align:center; margin-bottom: 10px;">
  <span class="nav-btn" id="prev-month">&lt; Poprzedni</span>
  &nbsp;&nbsp;
  <span class="nav-btn" id="next-month">Następny &gt;</span>
</div>
<table id="calendar">
  <caption id="caption"></caption>
  <thead>
    <tr><th>Nd</th><th>Pon</th><th>Wt</th><th>Śr</th><th>Czw</th><th>Pt</th><th>Sb</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const spreadsheetId = "1ktIEbiKcIvKHN3N8hkBz5_1UNDJa5a78xYNuf4hoWN4";
  const sheetName = "Rezerwacje";

  // Dane rezerwacji w formacie Set dat "YYYY-MM-DD"
  let busyDates = new Set();

  // Aktualny miesiąc i rok wyświetlany
  let currentYear, currentMonth;

  // Formatowanie daty YYYY-MM-DD
  function formatDate(d) {
    const mm = (d.getMonth() + 1).toString().padStart(2, '0');
    const dd = d.getDate().toString().padStart(2, '0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  // Pobierz dane z arkusza Google Sheets w formacie JSON (publiczny arkusz)
  async function fetchReservations() {
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const text = await res.text();
    // Google Sheets JSON jest opakowany w function call - trzeba wyciągnąć JSON
    const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
    const data = JSON.parse(jsonStr);

    busyDates.clear();

    // Przetwarzamy wiersze
    const rows = data.table.rows;
    for (const row of rows) {
      // Zakładam że Data jest w pierwszej kolumnie (c[0]), Imię i nazwisko w drugiej (c[1])
      const cellDate = row.c[0]?.v;
      const cellName = row.c[1]?.v;

      if (cellDate) {
        // Konwertuj datę na string YYYY-MM-DD
        // Google Sheets może dawać datę jako "2025-07-23" lub jako liczba (daty Excela)
        // Załóżmy, że jest tekst - jeśli nie, można dodać konwersję
        const dateStr = (typeof cellDate === 'string') ? cellDate.split(' ')[0] : null;
        if (dateStr) {
          busyDates.add(dateStr);
        }
      }
    }
  }

  // Renderowanie kalendarza na dany miesiąc i rok
  function renderCalendar(year, month) {
    currentYear = year;
    currentMonth = month;

    const caption = document.getElementById("caption");
    const tbody = document.querySelector("#calendar tbody");
    tbody.innerHTML = "";

    // Nazwy miesięcy
    const monthNames = ["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
    caption.textContent = `${monthNames[month]} ${year}`;

    // Pierwszy dzień miesiąca
    const firstDay = new Date(year, month, 1);
    const firstWeekDay = firstDay.getDay(); // niedziela=0 ... sobota=6

    // Ile dni w miesiącu
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Budujemy tablicę dni: niedziela jako pierwszy dzień tygodnia
    // Wstawiamy puste komórki przed 1 dniem
    let dayCounter = 1;
    let done = false;

    for (let week = 0; week < 6; week++) {
      if (done) break;
      const tr = document.createElement("tr");
      for (let wd = 0; wd < 7; wd++) {
        const td = document.createElement("td");
        // Wypełniamy komórki tylko jeśli odpowiadają dniom miesiąca
        if ((week === 0 && wd < firstWeekDay) || dayCounter > daysInMonth) {
          td.textContent = "";
        } else {
          const dateStr = formatDate(new Date(year, month, dayCounter));
          td.textContent = dayCounter;

          if (busyDates.has(dateStr)) {
            td.classList.add("busy");
            td.title = "Zajęty";
            // zamiast imienia i nazwiska - tekst "zajęty" w title, więc nie pokazujemy nazwiska
          }

          // Dziś zaznaczenie
          const today = new Date();
          if (year === today.getFullYear() && month === today.getMonth() && dayCounter === today.getDate()) {
            td.classList.add("today");
          }

          dayCounter++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      if (dayCounter > daysInMonth) done = true;
    }
  }

  // Inicjalizacja i pobranie danych
  async function init() {
    await fetchReservations();
    const now = new Date();
    renderCalendar(now.getFullYear(), now.getMonth());
  }

  // Nawigacja miesiące
  document.getElementById("prev-month").onclick = () => {
    let m = currentMonth - 1;
    let y = currentYear;
    if (m < 0) {
      m = 11;
      y--;
    }
    renderCalendar(y, m);
  };
  document.getElementById("next-month").onclick = () => {
    let m = currentMonth + 1;
    let y = currentYear;
    if (m > 11) {
      m = 0;
      y++;
    }
    renderCalendar(y, m);
  };

  init();
</script>

</body>
</html>
